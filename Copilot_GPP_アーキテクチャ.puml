@startuml
skinparam packageStyle rectangle
skinparam shadowing false
skinparam defaultTextAlignment center

title Circular View with Anomaly Detection Layer

' ===========================
' CIRCULAR LAYERS
' ===========================

circle "Goal\n(Find Giant)" as Goal
circle "Entities\n(Giantの本質)" as Entities
circle "UseCases\n(アプリケーションの振る舞い)" as UseCases
circle "Anomaly Detection\nLayer\n(未知の兆候検知)" as Anomaly
circle "Interface\nAdapters\n(技術抽象化)" as Adapters
circle "Frameworks & Drivers\n(技術層)" as Frameworks

' Concentric layout (hidden links)
Goal -[hidden]-> Entities
Entities -[hidden]-> UseCases
UseCases -[hidden]-> Anomaly
Anomaly -[hidden]-> Adapters
Adapters -[hidden]-> Frameworks

Goal <<circle>>
Entities <<circle>>
UseCases <<circle>>
Anomaly <<circle>>
Adapters <<circle>>
Frameworks <<circle>>

' ===========================
' RELATIONSHIPS (Outer → Inner)
' ===========================

Frameworks --> Adapters : depends on
Adapters --> Anomaly : implements ports
Anomaly --> UseCases : anomaly signals
UseCases --> Entities : uses domain
Goal -[dashed]-> Entities : conceptual guidance
Goal -[dashed]-> UseCases : conceptual guidance
Goal -[dashed]-> Anomaly : conceptual guidance

' ===========================
' NOTES
' ===========================

note right of Goal
  最大の目的（Policy）
  - 「Giantを発見する」
end note

note right of Entities
  ドメインの不変構造
  - Spacial information
  - Reservoir
  - Seal
  - Trap
  - Charge
  - Geological history
  - CRS
  - RiskScore
  - AnomalyScore (unknown unknown)
  - AnomalyFlag (unknown unknown)
end note

note right of UseCases
  アプリケーションの振る舞い
  - SearchDocuments
  - ScoreRisk
  - MapRisks
  - IntegrateCRS
  - ExplainRisk
end note

'false positive

note right of Anomaly
  異常検知レイヤー
  - DetectAnomalousSegmentsUseCase
  - DetectSpatialOutliersUseCase
  - DetectMonitoringAnomaliesUseCase
  - DetectKGStructuralAnomaliesUseCase
  - IAnomalyDetectionService（抽象ポート）
  - AnomalyScore / AnomalyFlag を生成
end note

note right of Adapters
  技術を抽象化する層
  - MongoGisRepository
  - MongoVectorSearchRepository
  - MongoKnowledgeGraphService
  - RiskScoringService: DHA, A_x_UI (AI based / Human decide)
  - LLMExplanationService
  - PolyPLAdapter
  - AnomalyDetectionAdapter（geology / seismic / KG構造）
end note

note right of Frameworks
  技術の実装層
  - GPP
  - FastAPI
  - MongoDB (2dsphere, Vector)
  - QGIS
  - AI API
  - DI Container
  - YAML/JSON Config
end note

@enduml